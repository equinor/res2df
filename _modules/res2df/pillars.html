

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>res2df.pillars &mdash; res2df 1.2.3.dev1+g2d697d2f documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />

  
      <script src="../../_static/jquery.js"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
      <script src="../../_static/doctools.js"></script>
      <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            res2df
              <img src="../../_static/equinor-logo2.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../res2csv.html">res2csv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../csv2res.html">csv2res</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribution.html">Contributing to res2df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../res2df/res2df.html"><code class="docutils literal notranslate"><span class="pre">res2df</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">res2df</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">res2df.pillars</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for res2df.pillars</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Extract statistics pr cornerpoint pillar (i,j)-pair&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">dateutil.parser</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">stack_on_colnames</span><span class="p">,</span> <span class="n">write_dframe_stdout_file</span>
<span class="kn">from</span> <span class="nn">.grid</span> <span class="kn">import</span> <span class="n">dates2rstindices</span>
<span class="kn">from</span> <span class="nn">.grid</span> <span class="kn">import</span> <span class="n">df</span> <span class="k">as</span> <span class="n">create_grid_df</span>
<span class="kn">from</span> <span class="nn">.res2csvlogger</span> <span class="kn">import</span> <span class="n">getLogger_res2csv</span>
<span class="kn">from</span> <span class="nn">.resdatafiles</span> <span class="kn">import</span> <span class="n">ResdataFiles</span>

<span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">AGGREGATORS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;VOLUME&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PORV&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PERMX&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PERMY&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PERMZ&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WATVOL&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GASVOL&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OILVOL&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GASVOLSURF&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OILVOLSURF&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OWC&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GOC&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GWC&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="df"><a class="viewcode-back" href="../../res2df/res2df.pillars.html#res2df.pillars.df">[docs]</a><span class="k">def</span> <span class="nf">df</span><span class="p">(</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">,</span>
    <span class="n">region</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rstdates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">soilcutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">sgascutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">swatcutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">stackdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produce a dataframe with pillar information</span>

<span class="sd">    This is the &quot;main&quot; function for Python API users</span>
<span class="sd">    Produces a dataframe with data for each I-J combination</span>
<span class="sd">    (in the column PILLAR), and if a region parameter is</span>
<span class="sd">    supplied, also pr. region.</span>

<span class="sd">    PORV is the summed porevolume of the pillar (in the region),</span>
<span class="sd">    VOLUME is bulk volume, and PORO is porevolume weighted porosity</span>
<span class="sd">    PERM columns contain unweighted value averages, use with caution.</span>

<span class="sd">    If a restart date is picked, then SWAT and SGAS will</span>
<span class="sd">    be used to compute volumes pr. phase, WATVOL, OILVOL and GASVOL. The</span>
<span class="sd">    columns with dynamic data will include the date in the column headers</span>
<span class="sd">    like SWAT@2009-01-01</span>

<span class="sd">    Args:</span>
<span class="sd">        region: A parameter the pillars will be split</span>
<span class="sd">            on. Typically EQLNUM or FIPNUM. Set to empty string</span>
<span class="sd">            or None to avoid any region grouping.</span>
<span class="sd">        rstdates: Dates for which restart data</span>
<span class="sd">            is to be extracted. The string can</span>
<span class="sd">            be in ISO-format, or one of the mnenomics</span>
<span class="sd">            &#39;first&#39;, &#39;last&#39; or &#39;all&#39;. It can also be a list</span>
<span class="sd">            of datetime.date.</span>
<span class="sd">        soilcutoff: If not None, an oil-water contact will</span>
<span class="sd">            be estimated pr. pillar, based on the deepest cell with</span>
<span class="sd">            SOIL above the given cutoff. Value is put in column OWC.</span>
<span class="sd">        sgascuttof: If not None, a gas contact will be</span>
<span class="sd">            estimated pr pillar, based on the deepest cell with</span>
<span class="sd">            SGAS above the given cutoff. Value is put in column GOC.</span>
<span class="sd">        swatcutoff: OWC or GWC is only computed for pillars</span>
<span class="sd">            where at least one cell is above this value.</span>
<span class="sd">        stackdates: If true, a column</span>
<span class="sd">            called DATE will be added and data for all restart</span>
<span class="sd">            dates will be added in a stacked manner.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># List of vectors we want, conservative in order to save memory and cputime:</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">region</span><span class="p">:</span>
        <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    <span class="n">vectors</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;POR*&quot;</span><span class="p">,</span> <span class="s2">&quot;PERM*&quot;</span><span class="p">,</span> <span class="s2">&quot;SWAT&quot;</span><span class="p">,</span> <span class="s2">&quot;SGAS&quot;</span><span class="p">,</span> <span class="s2">&quot;1OVERBO&quot;</span><span class="p">,</span> <span class="s2">&quot;1OVERBG&quot;</span><span class="p">])</span>
    <span class="n">grid_df</span> <span class="o">=</span> <span class="n">create_grid_df</span><span class="p">(</span>
        <span class="n">resdatafiles</span><span class="p">,</span> <span class="n">rstdates</span><span class="o">=</span><span class="n">rstdates</span><span class="p">,</span> <span class="n">vectors</span><span class="o">=</span><span class="n">vectors</span><span class="p">,</span> <span class="n">dateinheaders</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">rstdates_iso</span> <span class="o">=</span> <span class="n">dates2rstindices</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">,</span> <span class="n">rstdates</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;PILLAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;J&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing pillar statistics&quot;</span><span class="p">)</span>
    <span class="n">groupbies</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PILLAR&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">region</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Region parameter </span><span class="si">%s</span><span class="s2"> not found, ignored&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groupbies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
            <span class="n">grid_df</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">rstdates_iso</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dynamic volumes for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">datestr</span><span class="p">)</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="n">compute_volumes</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">datestr</span><span class="o">=</span><span class="n">datestr</span><span class="p">)</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">volumes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">aggregators</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">AGGREGATORS</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">grid_df</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">AGGREGATORS</span>
    <span class="p">}</span>

    <span class="c1"># Group over PILLAR and possibly regions:</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupbies</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregators</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Compute correct pillar averaged porosity (from bulk)</span>
    <span class="k">if</span> <span class="s2">&quot;PORV&quot;</span> <span class="ow">in</span> <span class="n">grouped</span> <span class="ow">and</span> <span class="s2">&quot;VOLUME&quot;</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="n">grouped</span><span class="p">[</span><span class="s2">&quot;PORO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s2">&quot;PORV&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">grouped</span><span class="p">[</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">]</span>

    <span class="c1"># Compute contacts:</span>
    <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">rstdates_iso</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;SWAT@&quot;</span> <span class="o">+</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">grid_df</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="s2">&quot;SOIL@&quot;</span> <span class="o">+</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">grid_df</span> <span class="ow">or</span> <span class="s2">&quot;SGAS@&quot;</span> <span class="o">+</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">grid_df</span>
        <span class="p">):</span>
            <span class="n">contacts</span> <span class="o">=</span> <span class="n">compute_pillar_contacts</span><span class="p">(</span>
                <span class="n">grid_df</span><span class="p">,</span>
                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">soilcutoff</span><span class="o">=</span><span class="n">soilcutoff</span><span class="p">,</span>
                <span class="n">sgascutoff</span><span class="o">=</span><span class="n">sgascutoff</span><span class="p">,</span>
                <span class="n">swatcutoff</span><span class="o">=</span><span class="n">swatcutoff</span><span class="p">,</span>
                <span class="n">datestr</span><span class="o">=</span><span class="n">datestr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contacts</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">grouped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">contacts</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stackdates</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stack_on_colnames</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="n">stackcolname</span><span class="o">=</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grouped</span></div>


<div class="viewcode-block" id="compute_volumes"><a class="viewcode-back" href="../../res2df/res2df.pillars.html#res2df.pillars.compute_volumes">[docs]</a><span class="k">def</span> <span class="nf">compute_volumes</span><span class="p">(</span>
    <span class="n">grid_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">datestr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute &quot;dynamic&quot; volumes, volumes for data coming from the</span>
<span class="sd">    UNRST file (SWAT+SGAS)</span>

<span class="sd">    SOIL is assumed not be present in grid_df, it will be computed here.</span>

<span class="sd">    Args:</span>
<span class="sd">        grid_df: A dataframe with the columns PORV, SWAT and SGAS</span>
<span class="sd">        datestr: If not none, it should contain an ISO-8601 formatted date that</span>
<span class="sd">            will be appended to all columns with dynamic data, SWAT and SGAS</span>
<span class="sd">            in incoming grid_df must also be appended with the same date string.</span>
<span class="sd">            If datestr is &quot;2009-01-02&quot;, then the columns will look</span>
<span class="sd">            like &quot;SOIL@2009-01-02&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">datestr</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">datestr</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">atdatestr</span> <span class="o">=</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datestr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">atdatestr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">vols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span> <span class="ow">and</span> <span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">-</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span> <span class="ow">and</span> <span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="c1"># Two-phase oil-water</span>
        <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span>
        <span class="c1"># (or it could be two-phase water-gas, but then the SOIL would mean the same)</span>

    <span class="k">if</span> <span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;WATVOL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;PORV&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;GASVOL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;PORV&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">vols</span><span class="p">:</span>
        <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;OILVOL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">=</span> <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;PORV&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;1OVERBO&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span> <span class="ow">and</span> <span class="s2">&quot;OILVOL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">vols</span><span class="p">:</span>
        <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;OILVOLSURF&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;OILVOL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;1OVERBO&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;1OVERBG&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span> <span class="ow">and</span> <span class="s2">&quot;GASVOL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">vols</span><span class="p">:</span>
        <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;GASVOLSURF&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">vols</span><span class="p">[</span><span class="s2">&quot;GASVOL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;1OVERBG&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">vols</span></div>


<div class="viewcode-block" id="compute_pillar_contacts"><a class="viewcode-back" href="../../res2df/res2df.pillars.html#res2df.pillars.compute_pillar_contacts">[docs]</a><span class="k">def</span> <span class="nf">compute_pillar_contacts</span><span class="p">(</span>
    <span class="n">grid_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">region</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">soilcutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">sgascutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">swatcutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">datestr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute contacts pr. pillar in a grid dataframe.</span>

<span class="sd">    Requires the columns PILLAR, SOIL, SGAS and SWAT, I, J and Z</span>

<span class="sd">    SOIL should be pre-computed in three-phase runs before calling this.</span>
<span class="sd">    PILLAR must be pre-computed in grid_df.</span>

<span class="sd">    OWC is deepest cell centre pr. pillar with oil saturation above soilcutoff,</span>
<span class="sd">    among those pillars with at least one cell above swatcutoff.</span>

<span class="sd">    GOC is the deepest cell centre pr. pillar with gas saturation above sgascutoff,</span>
<span class="sd">    among those pillars with at least one cell with non-zero oil saturation</span>

<span class="sd">    GWC is only computed when SOIL is not presented, and is the deepest</span>
<span class="sd">    cell centre with gas saturation above sgascutoff, among those pillars</span>
<span class="sd">    with at least one cell above swatcutoff.</span>

<span class="sd">    Args:</span>
<span class="sd">        grid_df: Representing the grid with geometry and properties</span>
<span class="sd">        region: Region vector to group by, e.g. FIPNUM or EQLNUM</span>
<span class="sd">        soilcutoff: OWC is deepest cell centre pr. pillar with oil</span>
<span class="sd">            saturation above this</span>
<span class="sd">        sgascutoff: GOC/GWC is deepest cell centre pr. pillar with</span>
<span class="sd">            gas saturation above this</span>
<span class="sd">        swatcutoff: Pillars must have this amount of water in (in one cell)</span>
<span class="sd">            them to be available for OWC/GWC computations.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Index is PILLAR with values I-J. Rows only for</span>
<span class="sd">        pillars where a contact was found. Empty dataframe if no contacts found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">swatcutoff</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">soilcutoff</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">sgascutoff</span> <span class="o">&lt;=</span> <span class="mi">1</span>

    <span class="c1"># assert datestr is None or in ISO-8601 format</span>
    <span class="n">atdatestr</span> <span class="o">=</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">datestr</span> <span class="k">if</span> <span class="n">datestr</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Non-user servicable parameter, for GOC computation</span>
    <span class="c1"># we require cells at the contact to contain a minute saturation</span>
    <span class="c1"># of oil. This is to avoid the code picking up gas injected in the</span>
    <span class="c1"># water phase.</span>
    <span class="n">epsilon_soil</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="k">if</span> <span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No saturation in grid data. No contacts computed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing contacts pr. pillar&quot;</span><span class="p">)</span>
    <span class="n">groupbies</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PILLAR&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;PILLAR&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;PILLAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;J&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;Z&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="c1"># To ensure same exception across Python 3.x:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Z column must be present in dataframe&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">region</span><span class="p">:</span>
        <span class="n">groupbies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    <span class="n">owc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">goc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Extract pillars with water in them. Only here would an OWC make sense.</span>
    <span class="n">waterpillars</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SWAT&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">swatcutoff</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupbies</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;min&quot;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">soilcutoff</span> <span class="ow">and</span> <span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Calculating oil-water-contacts based on SOILcutoff </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">soilcutoff</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">owc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">soilcutoff</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupbies</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">owc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;OWC&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">owc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Filter the owc frame to only those pillars that also has water:</span>
        <span class="n">owc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">waterpillars</span><span class="p">,</span> <span class="n">owc</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sgascutoff</span> <span class="ow">and</span> <span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating gas-contacts based on gas cutoff </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sgascutoff</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span> <span class="ow">and</span> <span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
            <span class="c1"># Pillars to be used for GOC computation</span>
            <span class="n">gocpillars</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">epsilon_soil</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupbies</span><span class="p">)</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">})</span>  <span class="c1"># The actual aggregation is not used.</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">goc</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">grid_df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sgascutoff</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SOIL&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">epsilon_soil</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupbies</span><span class="p">)</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">})</span>
            <span class="p">)</span>
            <span class="n">goc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;GOC&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Two-phase gas-water: GWC computation</span>
            <span class="n">gocpillars</span> <span class="o">=</span> <span class="n">waterpillars</span>  <span class="c1"># In case of gas-water</span>
            <span class="n">goc</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;SGAS&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sgascutoff</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupbies</span><span class="p">)</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">})</span>
            <span class="p">)</span>
            <span class="n">goc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;GWC&quot;</span> <span class="o">+</span> <span class="n">atdatestr</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">goc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Filter the goc frame to only those with oil or water:</span>
        <span class="n">goc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gocpillars</span><span class="p">,</span> <span class="n">goc</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

    <span class="c1"># We need to avoid merging with potentially empty DataFrames</span>
    <span class="k">if</span> <span class="n">owc</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="n">goc</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">owc</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="n">goc</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">owc</span>
    <span class="k">if</span> <span class="n">owc</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">goc</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">goc</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">owc</span><span class="p">,</span> <span class="n">goc</span><span class="p">)</span></div>


<div class="viewcode-block" id="fill_parser"><a class="viewcode-back" href="../../res2df/res2df.pillars.html#res2df.pillars.fill_parser">[docs]</a><span class="k">def</span> <span class="nf">fill_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up sys.argv parser.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        parser: argparse.ArgumentParser or argparse.subparser</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;DATAFILE&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the .DATA input file for the reservoir simulator.&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; There must exist .INIT and .EGRID files with the same path and basename.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--region&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Name of region parameter for which to separate the computations. &quot;</span>
            <span class="s2">&quot;Set to empty string to have no grouping (only by pillar).&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--rstdates&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Point in time to grab restart data from, &quot;</span>
            <span class="s2">&quot;either &#39;first&#39; or &#39;last&#39;, &#39;all&#39; or a date in &quot;</span>
            <span class="s2">&quot;YYYY-MM-DD format&quot;</span>
        <span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--stackdates&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If set, the dates from restart data will not be in the column &quot;</span>
            <span class="s2">&quot;but instead there will be a DATE column with the dates. Note &quot;</span>
            <span class="s2">&quot;that the static data will be repeated for each DATE.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--soilcutoff&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If supplied as float, an oil-water contact will &quot;</span>
            <span class="s2">&quot;be estimated pr. pillar, based on the deepest cell with &quot;</span>
            <span class="s2">&quot;SOIL above the given cutoff. Value is put in column OWC.&quot;</span>
        <span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--sgascutoff&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If supplied, a gas contact will be &quot;</span>
            <span class="s2">&quot;estimated pr pillar, based on the deepest cell with &quot;</span>
            <span class="s2">&quot;SGAS above the given cutoff. Value is put in column GOC. &quot;</span>
        <span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--swatcutoff&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;For OWC or GWC computations, only pillars with at least one cell &quot;</span>
            <span class="s2">&quot;with water saturation above this value will be considered.&quot;</span>
        <span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--group&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If set, output will not be pr. pillar, but grouped over &quot;</span>
            <span class="s2">&quot;all pillars. If --region is set, data will be grouped over that vector. &quot;</span>
            <span class="s2">&quot;The aggregation operator is sum or mean, depending on datatype.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of output csv file.&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;pillars.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Be verbose&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>


<div class="viewcode-block" id="pillars_main"><a class="viewcode-back" href="../../res2df/res2df.pillars.html#res2df.pillars.pillars_main">[docs]</a><span class="k">def</span> <span class="nf">pillars_main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the command line API&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger_res2csv</span><span class="p">(</span>  <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="vm">__name__</span><span class="p">,</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">resdatafiles</span> <span class="o">=</span> <span class="n">ResdataFiles</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">DATAFILE</span><span class="p">)</span>
    <span class="n">dframe</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span>
        <span class="n">resdatafiles</span><span class="p">,</span>
        <span class="n">region</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
        <span class="n">rstdates</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">rstdates</span><span class="p">,</span>
        <span class="n">soilcutoff</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">soilcutoff</span><span class="p">,</span>
        <span class="n">sgascutoff</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sgascutoff</span><span class="p">,</span>
        <span class="n">swatcutoff</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">swatcutoff</span><span class="p">,</span>
        <span class="n">stackdates</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">stackdates</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">groupbies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aggregators</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">AGGREGATORS</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dframe</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">AGGREGATORS</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">region</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
        <span class="n">groupbies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">stackdates</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
        <span class="n">groupbies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">groupbies</span><span class="p">:</span>
        <span class="n">dframe</span> <span class="o">=</span> <span class="n">dframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupbies</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregators</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
        <span class="n">dframe</span> <span class="o">=</span> <span class="n">dframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;PILLAR&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">dframe</span><span class="p">[</span><span class="s2">&quot;PORO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dframe</span><span class="p">[</span><span class="s2">&quot;PORV&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dframe</span><span class="p">[</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">]</span>
    <span class="n">write_dframe_stdout_file</span><span class="p">(</span><span class="n">dframe</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">caller_logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Equinor 2019-2024.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #ff1243;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #474747;
    }
    .wy-side-nav-search > div.version {
      color: white;
    }
  </style>


</body>
</html>