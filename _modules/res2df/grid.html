

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>res2df.grid &mdash; res2df 1.3.2.dev7+g5a83bb1d documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />

  
      <script src="../../_static/jquery.js"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
      <script src="../../_static/doctools.js"></script>
      <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            res2df
              <img src="../../_static/equinor-logo2.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../res2csv.html">res2csv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../csv2res.html">csv2res</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribution.html">Contributing to res2df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../res2df/res2df.html"><code class="docutils literal notranslate"><span class="pre">res2df</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">res2df</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">res2df.grid</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for res2df.grid</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Extract grid information from grid files as Dataframes.</span>

<span class="sd">Each cell in the grid correspond to one row.</span>

<span class="sd">For grid cells, x, y, z for cell centre and volume is available as</span>
<span class="sd">geometric information. Static data (properties) can be merged from</span>
<span class="sd">the INIT file, and dynamic data can be merged from the Restart (UNRST)</span>
<span class="sd">file.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fnmatch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dateutil.parser</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.feather</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">resfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">resdata.resfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResdataFile</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.__version__</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.common</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">comment_formatter</span><span class="p">,</span>
    <span class="n">merge_zones</span><span class="p">,</span>
    <span class="n">runlength_compress</span><span class="p">,</span>
    <span class="n">write_dframe_stdout_file</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.res2csvlogger</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger_res2csv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.resdatafiles</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResdataFiles</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_available_rst_dates"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.get_available_rst_dates">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">get_available_rst_dates</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of datetime objects for the available dates in the RST file&quot;&quot;&quot;</span>
    <span class="n">report_indices</span> <span class="o">=</span> <span class="n">ResdataFile</span><span class="o">.</span><span class="n">file_report_list</span><span class="p">(</span><span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_rstfilename</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Restart report indices (count </span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">report_indices</span><span class="p">)),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">report_indices</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_rstfile</span><span class="p">()</span><span class="o">.</span><span class="n">iget_restart_sim_time</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">report_indices</span><span class="p">))</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="dates2rstindices"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.dates2rstindices">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">dates2rstindices</span><span class="p">(</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">,</span>
    <span class="n">dates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">]]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the restart index/indices for a given datetime or list of datetimes</span>

<span class="sd">      dates: datetime.date or list of datetime.date, must</span>
<span class="sd">          correspond to an existing date. If list, it</span>
<span class="sd">          forces dateinheaders to be True.</span>
<span class="sd">          Can also be string, then the mnenomics</span>
<span class="sd">          &#39;first&#39;, &#39;last&#39;, &#39;all&#39;, are supported, or ISO</span>
<span class="sd">          date formats. If None or empty string is supplied,</span>
<span class="sd">          an empty return tuple is returned.</span>

<span class="sd">    Raises exception if no dates are not found.</span>

<span class="sd">    Return: tuple, first element is</span>
<span class="sd">        list of integers, corresponding to restart indices. Length 1 or more.</span>
<span class="sd">        second element is list of corresponding datetime.date objecs, third</span>
<span class="sd">        is an ISO-8601 representation of the dates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dates</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">([],</span> <span class="p">[],</span> <span class="p">[])</span>

    <span class="n">availabledates</span> <span class="o">=</span> <span class="n">get_available_rst_dates</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">)</span>

    <span class="n">supportedmnemonics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]</span>

    <span class="c1"># After this control block, chosendates is a list of dates</span>
    <span class="c1"># we should extract, and which exists in UNRST.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dates</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supportedmnemonics</span><span class="p">:</span>
            <span class="c1"># Try to parse as ISO date:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">isodate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">isoparse</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">dateparser_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;date &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; not understood&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">dateparser_error</span>
            <span class="k">if</span> <span class="n">isodate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">availabledates</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;date &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">isodate</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; not found in UNRST file&quot;</span><span class="p">)</span>
            <span class="n">chosendates</span> <span class="o">=</span> <span class="p">[</span><span class="n">isodate</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dates</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span>
            <span class="n">chosendates</span> <span class="o">=</span> <span class="p">[</span><span class="n">availabledates</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">dates</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
            <span class="n">chosendates</span> <span class="o">=</span> <span class="p">[</span><span class="n">availabledates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">dates</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">chosendates</span> <span class="o">=</span> <span class="n">availabledates</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="n">chosendates</span> <span class="o">=</span> <span class="p">[</span><span class="n">dates</span><span class="o">.</span><span class="n">date</span><span class="p">()]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
        <span class="c1"># Beware, datetime.datetime would also match here.</span>
        <span class="n">chosendates</span> <span class="o">=</span> <span class="p">[</span><span class="n">dates</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">chosendates</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dates</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">availabledates</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chosendates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;None of the requested dates were found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosendates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">availabledates</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not all dates found in UNRST</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;date &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; not understood&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Available dates (count </span><span class="si">%s</span><span class="s2">) in RST: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">availabledates</span><span class="p">)),</span>
        <span class="nb">str</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">availabledates</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="n">rstindices</span> <span class="o">=</span> <span class="p">[</span><span class="n">availabledates</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chosendates</span><span class="p">]</span>
    <span class="n">isostrings</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chosendates</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rstindices</span><span class="p">,</span> <span class="n">chosendates</span><span class="p">,</span> <span class="n">isostrings</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_df2pyarrow</span><span class="p">(</span><span class="n">dframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a pyarrow table from dataframe with</span>
<span class="sd">    grid information</span>

<span class="sd">    The index in the dataframe will be ignored</span>

<span class="sd">    32-bit types will be used for integers and floats (todo)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pyarrow</span><span class="o">.</span><span class="n">Field</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">dframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer_dtype</span><span class="p">(</span><span class="n">dframe</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">colname</span><span class="p">]):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">int32</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_string_dtype</span><span class="p">(</span><span class="n">dframe</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">colname</span><span class="p">]):</span>
            <span class="c1"># Parameters are potentially merged into the dataframe.</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">string</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">float32</span><span class="p">()</span>
        <span class="n">field_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyarrow</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">field_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">dframe</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">preserve_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="rst2df"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.rst2df">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">rst2df</span><span class="p">(</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">,</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">]],</span>
    <span class="n">vectors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dateinheaders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">stackdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a dataframe with dynamic data from the restart file</span>
<span class="sd">    for each cell, at a particular date.</span>

<span class="sd">    The dataframe will have a dummy index. The column named</span>
<span class="sd">    &quot;active&quot; refers to the active cell index, and is to be used</span>
<span class="sd">    when merging with the grid geometry dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        resdatafiles: ResdataFiles object</span>
<span class="sd">        date: datetime.date or list of datetime.date, must</span>
<span class="sd">            correspond to an existing date. If list, it</span>
<span class="sd">            forces dateinheaders to be True.</span>
<span class="sd">            Can also be string, then the mnenomics</span>
<span class="sd">            &#39;first&#39;, &#39;last&#39;, &#39;all&#39;, are supported, or ISO</span>
<span class="sd">            date formats.</span>
<span class="sd">         vectors: List of vectors to include,</span>
<span class="sd">            glob-style wildcards supported</span>
<span class="sd">         dateinheaders: boolean on whether the date should</span>
<span class="sd">            be added to the column headers. Instead of</span>
<span class="sd">            SGAS as a column header, you get SGAS@YYYY-MM-DD.</span>
<span class="sd">         stackdates: Default is false. If True, a column</span>
<span class="sd">            called DATE will be added and data for all restart</span>
<span class="sd">            dates will be added in a stacked manner. Implies</span>
<span class="sd">            dateinheaders False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vectors</span><span class="p">:</span>
        <span class="n">vectorswasdefaulted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>  <span class="c1"># This will include everything</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vectorswasdefaulted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">vectors</span><span class="p">]</span>

    <span class="c1"># First task is to determine the restart index to extract</span>
    <span class="c1"># data for:</span>
    <span class="p">(</span><span class="n">rstindices</span><span class="p">,</span> <span class="n">chosendates</span><span class="p">,</span> <span class="n">isodates</span><span class="p">)</span> <span class="o">=</span> <span class="n">dates2rstindices</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting restart information at dates </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">isodates</span><span class="p">))</span>

    <span class="c1"># Determine the available restart vectors, we only include</span>
    <span class="c1"># those with correct length, meaning that they are defined</span>
    <span class="c1"># for all active cells:</span>
    <span class="n">activecells</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_egrid</span><span class="p">()</span><span class="o">.</span><span class="n">getNumActive</span><span class="p">()</span>
    <span class="n">rstvectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">resfo</span><span class="o">.</span><span class="n">lazy_read</span><span class="p">(</span><span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_rstfilename</span><span class="p">()):</span>
        <span class="n">keyword_name</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">read_keyword</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">read_length</span><span class="p">()</span> <span class="o">==</span> <span class="n">activecells</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">keyword_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vectors</span>
        <span class="p">):</span>
            <span class="n">rstvectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword_name</span><span class="p">)</span>
    <span class="n">rstvectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rstvectors</span><span class="p">))</span>  <span class="c1"># Make unique list</span>
    <span class="c1"># Note that all of these might not exist at all timesteps.</span>

    <span class="k">if</span> <span class="n">stackdates</span> <span class="ow">and</span> <span class="n">dateinheaders</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will not put date in headers when stackdates=True&quot;</span><span class="p">)</span>
        <span class="n">dateinheaders</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">rst_dfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">rstindex</span> <span class="ow">in</span> <span class="n">rstindices</span><span class="p">:</span>
        <span class="c1"># Filter the rst vectors once more, all of them</span>
        <span class="c1"># might not be available at all timesteps:</span>
        <span class="n">present_rstvectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">rstvectors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_rstfile</span><span class="p">()</span><span class="o">.</span><span class="n">iget_named_kw</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">rstindex</span><span class="p">):</span>
                    <span class="n">present_rstvectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Present restart vectors at index </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">rstindex</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">present_rstvectors</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">present_rstvectors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vectorswasdefaulted</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No restart vectors available at index </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rstindex</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Make the dataframe</span>
        <span class="n">rst_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">present_rstvectors</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_rstfile</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">iget_named_kw</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">rstindex</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">numpyView</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">present_rstvectors</span>
                <span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># For users convenience:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;SWAT&quot;</span> <span class="ow">in</span> <span class="n">rst_df</span>
            <span class="ow">and</span> <span class="s2">&quot;SGAS&quot;</span> <span class="ow">in</span> <span class="n">rst_df</span>
            <span class="ow">and</span> <span class="s2">&quot;SOIL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rst_df</span>
            <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="s2">&quot;SOIL&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vectors</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">rst_df</span><span class="p">[</span><span class="s2">&quot;SOIL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rst_df</span><span class="p">[</span><span class="s2">&quot;SWAT&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">rst_df</span><span class="p">[</span><span class="s2">&quot;SGAS&quot;</span><span class="p">]</span>

        <span class="c1"># Tag the column names if requested, or if multiple rst indices</span>
        <span class="c1"># are asked for</span>
        <span class="n">datestr</span> <span class="o">=</span> <span class="n">chosendates</span><span class="p">[</span><span class="n">rstindices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rstindex</span><span class="p">)]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dateinheaders</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rstindices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stackdates</span><span class="p">:</span>
            <span class="n">rst_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">datestr</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">rst_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="c1"># resdata emits a number around -1.0000000200408773e+20 which</span>
        <span class="c1"># should be considered Not-a-number</span>
        <span class="n">rst_df</span> <span class="o">=</span> <span class="n">rst_df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rst_df</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e20</span> <span class="o">+</span> <span class="mf">1e13</span><span class="p">)</span>  <span class="c1"># some trial and error</span>

        <span class="c1"># Remove columns that are all NaN:</span>
        <span class="n">rst_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">rst_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>

        <span class="n">rst_dfs</span><span class="p">[</span><span class="n">datestr</span><span class="p">]</span> <span class="o">=</span> <span class="n">rst_df</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rst_dfs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">stackdates</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rst_dfs</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">rststack</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rst_dfs</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">rststack</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;level_0&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rststack</span></div>


<div class="viewcode-block" id="gridgeometry2df"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.gridgeometry2df">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">gridgeometry2df</span><span class="p">(</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">,</span> <span class="n">zonemap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produce a Pandas Dataframe with grid geometry</span>

<span class="sd">    Order is significant, and is determined by the order from resdata, and used</span>
<span class="sd">    when merging with other dataframes with cell-data.</span>

<span class="sd">    Args:</span>
<span class="sd">        resdatafiles: object holding the :term:`output files &lt;output file&gt;`.</span>
<span class="sd">        zonemap: A zonemap dictionary mapping every K index to a</span>
<span class="sd">            string, which will be put in a column ZONE. If none is provided,</span>
<span class="sd">            a zonemap from a default file will be looked for. Provide an empty</span>
<span class="sd">            dictionary to avoid looking for the default file, and no ZONE</span>
<span class="sd">            column will be added.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with at least the columns I, J, K, X, Y, Z and VOLUME. One row</span>
<span class="sd">        pr. cell. The index of the dataframe are the global indices. If a zonemap</span>
<span class="sd">        is provided, zone information will be in the column ZONE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">egrid_file</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_egridfile</span><span class="p">()</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_egrid</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">egrid_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">grid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No EGRID file supplied&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting grid geometry from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">egrid_file</span><span class="p">))</span>
    <span class="n">index_frame</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">export_index</span><span class="p">(</span><span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ijk</span> <span class="o">=</span> <span class="n">index_frame</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># ijk from resdata.grid is off by one</span>

    <span class="n">xyz</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">export_position</span><span class="p">(</span><span class="n">index_frame</span><span class="p">)</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">export_volume</span><span class="p">(</span><span class="n">index_frame</span><span class="p">)</span>
    <span class="n">z_corners</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">export_corners</span><span class="p">(</span><span class="n">index_frame</span><span class="p">)[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">]]</span>
    <span class="n">grid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">index_frame</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;i&quot;</span><span class="p">,</span>
            <span class="s2">&quot;j&quot;</span><span class="p">,</span>
            <span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;z&quot;</span><span class="p">,</span>
            <span class="s2">&quot;z_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;z_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
            <span class="s2">&quot;global_index&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">ijk</span><span class="p">,</span>
                <span class="n">xyz</span><span class="p">,</span>
                <span class="n">z_corners</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">z_corners</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">vol</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index_frame</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Type conversion, hstack maybe ruined the datatypes..</span>
    <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Column names should be uppercase</span>
    <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">zonemap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Look for default zonemap file:</span>
        <span class="n">zonemap</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_zonemap</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">zonemap</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Merging zonemap into grid&quot;</span><span class="p">)</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">merge_zones</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">zonemap</span><span class="p">,</span> <span class="n">kname</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grid_df</span></div>


<div class="viewcode-block" id="merge_initvectors"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.merge_initvectors">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">merge_initvectors</span><span class="p">(</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">,</span>
    <span class="n">dframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">initvectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">ijknames</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge in INIT vectors to a dataframe by I, J, K.</span>

<span class="sd">    Utility function for other modules to use. Normally it is sufficient</span>
<span class="sd">    for API users to only use the df() function.</span>

<span class="sd">    Args:</span>
<span class="sd">        resdatafiles: Object representing the :term:`output files &lt;output file&gt;`</span>
<span class="sd">        dframe: Table data to merge with</span>
<span class="sd">        initvectors: Names of INIT vectors to merge in.</span>
<span class="sd">        ijknames: Three strings that determine the I, J and K columns to use</span>
<span class="sd">            for merging in dframe. For compdat the &#39;K&#39; is f.ex. denoted &#39;K1&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Copy of incoming dataframe with additional columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">initvectors</span><span class="p">:</span>
        <span class="c1"># Nothing to do.</span>
        <span class="k">return</span> <span class="n">dframe</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ijknames</span><span class="p">:</span>
        <span class="n">ijknames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ijknames</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ijknames must be a list of length 3&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">,</span> <span class="n">ResdataFiles</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">ijknames</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">dframe</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;All of the columns </span><span class="si">{</span><span class="n">ijknames</span><span class="si">}</span><span class="s2"> must be present &quot;</span>
            <span class="s2">&quot;in the dataframe for merging&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initvectors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">initvectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">initvectors</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initvectors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Merging INIT data </span><span class="si">%s</span><span class="s2"> into dataframe&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">initvectors</span><span class="p">))</span>
    <span class="n">ijkinit</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">,</span> <span class="n">vectors</span><span class="o">=</span><span class="n">initvectors</span><span class="p">)[[</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">initvectors</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dframe</span><span class="p">,</span> <span class="n">ijkinit</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="n">ijknames</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="init2df"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.init2df">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">init2df</span><span class="p">(</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract information from INIT file with cell data</span>

<span class="sd">    Normally, you would use the df() function which will</span>
<span class="sd">    call this function on your behalf.</span>

<span class="sd">    Order is significant, as index is used for merging</span>

<span class="sd">    Args:</span>
<span class="sd">        resdatafiles: Object that can serve the EGRID and INIT files</span>
<span class="sd">        vectors: List of vectors to include,</span>
<span class="sd">            glob-style wildcards supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vectors</span><span class="p">:</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>  <span class="c1"># This will include everything</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">vectors</span><span class="p">]</span>

    <span class="n">init</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_initfile</span><span class="p">()</span>
    <span class="n">egrid</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_egrid</span><span class="p">()</span>

    <span class="c1"># Build list of vector names to include:</span>
    <span class="n">usevectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">include_porv</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">init</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">egrid</span><span class="o">.</span><span class="n">getNumActive</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vectors</span>
        <span class="p">):</span>
            <span class="n">usevectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PORV&quot;</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="s2">&quot;PORV&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vectors</span><span class="p">):</span>
            <span class="n">include_porv</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">usevectors</span><span class="p">:</span>
        <span class="n">init_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">usevectors</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">init</span><span class="o">.</span><span class="n">iget_named_kw</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpyView</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">usevectors</span>
                <span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># resdata emits a number around -1.0000000200408773e+20 which</span>
        <span class="c1"># should be considered Not-a-number</span>
        <span class="n">init_df</span> <span class="o">=</span> <span class="n">init_df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">init_df</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e20</span> <span class="o">+</span> <span class="mf">1e13</span><span class="p">)</span>  <span class="c1"># some trial and error</span>

        <span class="c1"># Remove columns that are all NaN:</span>
        <span class="n">init_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">init_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>  <span class="c1"># empty</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracted </span><span class="si">%s</span><span class="s2"> from INIT file&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">init_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="c1"># PORV is indexed by active_index, not global, needs special treatment:</span>
    <span class="k">if</span> <span class="n">include_porv</span><span class="p">:</span>
        <span class="n">porv_numpy</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">iget_named_kw</span><span class="p">(</span><span class="s2">&quot;PORV&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpyView</span><span class="p">()</span>
        <span class="n">glob_idxs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">egrid</span><span class="o">.</span><span class="n">get_global_index</span><span class="p">(</span><span class="n">active_index</span><span class="o">=</span><span class="n">ix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">egrid</span><span class="o">.</span><span class="n">getNumActive</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">init_df</span><span class="p">[</span><span class="s2">&quot;PORV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">porv_numpy</span><span class="p">[</span><span class="n">glob_idxs</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">init_df</span></div>


<div class="viewcode-block" id="df"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.df">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">df</span><span class="p">(</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">ResdataFiles</span><span class="p">,</span>
    <span class="n">vectors</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">dropconstants</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">rstdates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dateinheaders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">stackdates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">zonemap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produce a dataframe with grid information</span>

<span class="sd">    Grid information (center coordinates x, y, z), cell</span>
<span class="sd">    indices (i, j, k) (indices follow the Eclipse convention starting</span>
<span class="sd">    at 1, not zero as in resdata), properties from INIT, and optionally</span>
<span class="sd">    any time dependent data from Restart files.</span>

<span class="sd">    Args:</span>
<span class="sd">        resdatafiles: Handle to a simulator case</span>
<span class="sd">        vectors: Vectors to include, wildcards</span>
<span class="sd">            supported. Used to match both</span>
<span class="sd">            INIT vectors and RESTART vectors.</span>
<span class="sd">        dropconstants (bool): If true, columns that are constant</span>
<span class="sd">            for every cell are dropped.</span>
<span class="sd">        rstdates: Restart dates to include in ISO-8601 format.</span>
<span class="sd">            Alternatively, pick from the mnenomics &#39;first&#39;, &#39;all&#39; and &#39;last&#39;.</span>
<span class="sd">        dateinheaders: Whether columns with data from UNRST files</span>
<span class="sd">            should always have the ISO-date embedded in the column header.</span>
<span class="sd">        stackdates: Default is false. If true, a column</span>
<span class="sd">            called DATE will be added and data for all restart</span>
<span class="sd">            dates will be added in a stacked manner. Implies</span>
<span class="sd">            dateinheaders False.</span>
<span class="sd">        zonemap: A zonemap dictionary mapping every K index to a</span>
<span class="sd">            string, which will be put in a column ZONE. If none is provided,</span>
<span class="sd">            a zonemap from a default file will be looked for. Provide an empty</span>
<span class="sd">            dictionary to avoid looking for the default file, and no ZONE</span>
<span class="sd">            column will be added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gridgeom</span> <span class="o">=</span> <span class="n">gridgeometry2df</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">,</span> <span class="n">zonemap</span><span class="p">)</span>
    <span class="n">initdf</span> <span class="o">=</span> <span class="n">init2df</span><span class="p">(</span><span class="n">resdatafiles</span><span class="p">,</span> <span class="n">vectors</span><span class="o">=</span><span class="n">vectors</span><span class="p">)</span>
    <span class="n">rst_df</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">rstdates</span><span class="p">:</span>
        <span class="n">rst_df</span> <span class="o">=</span> <span class="n">rst2df</span><span class="p">(</span>
            <span class="n">resdatafiles</span><span class="p">,</span>
            <span class="n">rstdates</span><span class="p">,</span>
            <span class="n">vectors</span><span class="o">=</span><span class="n">vectors</span><span class="p">,</span>
            <span class="n">dateinheaders</span><span class="o">=</span><span class="n">dateinheaders</span><span class="p">,</span>
            <span class="n">stackdates</span><span class="o">=</span><span class="n">stackdates</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">grid_df</span> <span class="o">=</span> <span class="n">gridgeom</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">initdf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">rst_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rst_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">rst_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;active&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dropconstants</span><span class="p">:</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">drop_constant_columns</span><span class="p">(</span><span class="n">grid_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fill_parser"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.fill_parser">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">fill_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up sys.argv parser.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        parser: argparse.ArgumentParser or argparse.subparser</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;DATAFILE&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the .DATA input file for the reservoir simulator.&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; There must exist .INIT and .EGRID files with the same path and basename.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--vectors&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;INIT and/or restart wildcards for vectors to include&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--rstdates&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Point in time to grab restart data from, &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;either &#39;first&#39; or &#39;last&#39;, &#39;all&#39;, or a date in &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;YYYY-MM-DD format&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of output csv file. Use &#39;-&#39; for stdout.&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;eclgrid.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--stackdates&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If set, the dates from restart data will not be in the column &quot;</span>
            <span class="s2">&quot;but instead there will be a DATE column with the dates. Note &quot;</span>
            <span class="s2">&quot;that the static data will be repeated for each DATE.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--dropconstants&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Drop constant columns from the dataset&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Be verbose&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--arrow&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Write to pyarrow format&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>


<div class="viewcode-block" id="drop_constant_columns"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.drop_constant_columns">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">drop_constant_columns</span><span class="p">(</span>
    <span class="n">dframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alwayskeep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drop/delete constant columns from a dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        dframe</span>
<span class="sd">        alwayskeep: string or list of strings of columns to keep</span>
<span class="sd">           anyway.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dataframe with equal or less columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">alwayskeep</span><span class="p">:</span>
        <span class="n">alwayskeep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alwayskeep</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">alwayskeep</span> <span class="o">=</span> <span class="p">[</span><span class="n">alwayskeep</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alwayskeep</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;alwayskeep must be a list&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dropconstants() needs a dataframe&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dframe</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dframe</span>

    <span class="n">columnstodelete</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">alwayskeep</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">columnstodelete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">columnstodelete</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting constant columns </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">columnstodelete</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columnstodelete</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="df2res"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.df2res">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">df2res</span><span class="p">(</span>
    <span class="n">grid_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">keywords</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">resdatafiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResdataFiles</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nocomments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a :term:`include file` contents with grid data keyword, like PERMX, PORO,</span>
<span class="sd">    FIPNUM etc, for the GRID section of the :term:`.DATA file`.</span>

<span class="sd">    Output (returned as string and optionally written to file) will then</span>
<span class="sd">    contain f.ex::</span>

<span class="sd">        PERMX</span>
<span class="sd">           3.3 4.1 500.1 8543.0 1223.0 5022.0</span>
<span class="sd">           411.455 4433.9</span>
<span class="sd">        /</span>

<span class="sd">    if the grid contains 8 cells (inactive and active).</span>

<span class="sd">    Args:</span>
<span class="sd">        grid_df: Dataframe with the keyword for which</span>
<span class="sd">            we want to export data, and also the a column with GLOBAL_INDEX.</span>
<span class="sd">            Without GLOBAL_INDEX, the output will likely be invalid.</span>
<span class="sd">            The grid can contain both active and inactive cells.</span>
<span class="sd">        keywords: The keyword(s) to export, with one</span>
<span class="sd">            value for every cell.</span>
<span class="sd">        resdatafiles: If provided, the total cell count for the grid</span>
<span class="sd">            will be requested from this object. If not, it will be *guessed*</span>
<span class="sd">            from the maximum number of GLOBAL_INDEX, which can be under-estimated</span>
<span class="sd">            in the corner-case that the last cells are inactive.</span>
<span class="sd">        dtype: If provided, the columns which are</span>
<span class="sd">            outputted are converted to int or float. Dataframe columns</span>
<span class="sd">            read from CSV files easily gets the wrong type, while Eclipse</span>
<span class="sd">            might require some data to be strictly integer.</span>
<span class="sd">        filename: If provided, the string produced will also to be</span>
<span class="sd">            written to this filename.</span>
<span class="sd">        nocomments: Set to True to avoid any comments being written. Defaults</span>
<span class="sd">            to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">keywords</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span>
        <span class="k">elif</span> <span class="n">dtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong dtype argument </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Figure out the total number of cells for which we need to export data for:</span>
    <span class="n">global_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">active_cells</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">resdatafiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_egrid</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">global_size</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_egrid</span><span class="p">()</span><span class="o">.</span><span class="n">get_global_size</span><span class="p">()</span>
        <span class="n">active_cells</span> <span class="o">=</span> <span class="n">resdatafiles</span><span class="o">.</span><span class="n">get_egrid</span><span class="p">()</span><span class="o">.</span><span class="n">getNumActive</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;GLOBAL_INDEX&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;Global index not found in grid dataframe. Assumes all cells are active&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Drop NaN rows for columns to be used (triggered by stacked</span>
        <span class="c1"># dates and no global index, unlikely)</span>
        <span class="c1"># Also copy dataframe to avoid side-effects on incoming data.</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;GLOBAL_INDEX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">index</span>

    <span class="k">if</span> <span class="n">global_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">global_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;GLOBAL_INDEX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">active_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Global grid size estimated to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">global_size</span><span class="p">))</span>

    <span class="n">res2df_header</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Output file printed by &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;res2df.grid &quot;</span>
        <span class="o">+</span> <span class="n">__version__</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; at &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nocomments</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="n">comment_formatter</span><span class="p">(</span><span class="n">res2df_header</span><span class="p">)</span>
    <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># If we have NaNs in the dataframe, we will be more careful (costs memory)</span>
    <span class="k">if</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keyword </span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2"> not found in grid dataframe&quot;</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">global_size</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;GLOBAL_INDEX&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="o">!=</span> <span class="n">global_size</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Mismatch between dumped vector length &quot;</span>
                    <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> from df2res and assumed grid size </span><span class="si">%d</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">),</span>
                <span class="n">global_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Data will be dumped, but may error in simulator&quot;</span><span class="p">)</span>
        <span class="n">strvector</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vector</span><span class="p">])</span>
        <span class="n">strvector</span> <span class="o">=</span> <span class="n">runlength_compress</span><span class="p">(</span><span class="n">strvector</span><span class="p">)</span>

        <span class="n">string</span> <span class="o">+=</span> <span class="n">keyword</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span>
                <span class="n">strvector</span><span class="p">,</span> <span class="n">initial_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">subsequent_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nocomments</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; -- </span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">active_cells</span><span class="si">}</span><span class="s2"> active cells, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_size</span><span class="si">}</span><span class="s2"> total cell count</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span></div>


<div class="viewcode-block" id="grid_main"><a class="viewcode-back" href="../../res2df/res2df.grid.html#res2df.grid.grid_main">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">grid_main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the command line API&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger_res2csv</span><span class="p">(</span>  <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="vm">__name__</span><span class="p">,</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">resdatafiles</span> <span class="o">=</span> <span class="n">ResdataFiles</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">DATAFILE</span><span class="p">)</span>
    <span class="n">grid_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span>
        <span class="n">resdatafiles</span><span class="p">,</span>
        <span class="n">vectors</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span>
        <span class="n">rstdates</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">rstdates</span><span class="p">,</span>
        <span class="n">dropconstants</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropconstants</span><span class="p">,</span>
        <span class="n">stackdates</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">stackdates</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">arrow</span><span class="p">:</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">_df2pyarrow</span><span class="p">(</span><span class="n">grid_df</span><span class="p">)</span>
    <span class="n">write_dframe_stdout_file</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">caller_logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Equinor 2019-2025.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #ff1243;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #474747;
    }
    .wy-side-nav-search > div.version {
      color: white;
    }
  </style>


</body>
</html>